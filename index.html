<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pediatric Anesthesia Calculator</title>

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0089f0">
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Modern Vibrant Material-Inspired CSS - INCREASED CONTRAST */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Punchy Vibrant Palette - Increased Contrast */
            --bg-primary: #ffffff;
            --bg-secondary: #f0f4f8; /* Light background for lift, subtle contrast */
            --bg-card: #ffffff;
            --text-primary: #121212; /* Very high contrast dark grey/black */
            --text-secondary: #546e7a; /* Blue Grey for detail */
            --text-tertiary: #b0bec5;
            --border-color: #e1f5fe; /* Lighter, more vibrant border */
            --shadow: 0 8px 24px rgba(0, 0, 0, 0.15); /* Stronger shadow */
            --shadow-hover: 0 12px 30px rgba(0, 0, 0, 0.2);

            /* Very Vibrant Accent Colors (HIGH SATURATION) */
            --induction: #00e5ff; /* Vibrant Cyan */
            --muscle-relaxant: #ff6d00; /* Vibrant Deep Orange */
            --analgesic: #00c853; /* Vibrant Emerald Green */
            --adjunct: #d500f9; /* Vibrant Magenta */
            --reversal: #ff1744; /* Vibrant Red */
            --emergency: #ffc400; /* Deep Amber/Gold */
            --steroid: #3f51b5; /* Deeper Indigo */
            --antiemetic: #8bc34a; /* Light Green */
            --primary-accent: #0089f0; /* Brighter Blue */

            --radius-card: 16px;
            --radius-input: 10px;
        }

        body.dark-mode {
            --bg-primary: #121212; /* Darker primary */
            --bg-secondary: #1e1e1e; /* Darker secondary */
            --bg-card: #282828;
            --text-primary: #e0e0e0; /* High contrast white/grey */
            --text-secondary: #9e9e9e;
            --border-color: #3e3e3e;
            --shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
            --shadow-hover: 0 12px 30px rgba(0, 0, 0, 0.8);
            
            /* Dark Mode Accents - kept bright for contrast against dark background */
            --emergency: #ffeb3b;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background-color 0.4s, color 0.4s;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        header {
            background: var(--primary-accent);
            color: var(--bg-primary);
            padding: 30px;
            border-radius: var(--radius-card);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: fadeInDown 0.5s ease-out;
        }

        h1 {
            font-size: 2.2em;
            font-weight: 700;
        }

        .dark-mode-toggle {
            background: var(--bg-primary);
            color: var(--primary-accent);
            border: none;
            border-radius: 50px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .dark-mode-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .section, .patient-info {
            background: var(--bg-card);
            padding: 25px;
            border-radius: var(--radius-card);
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            transition: box-shadow 0.3s ease;
        }

        .section h2 {
            font-size: 1.6em;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
            border-bottom: 3px solid var(--border-color);
            padding-bottom: 10px;
        }

        /* Input Styling */
        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .input-field label {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 600;
            display: block;
        }

        .input-field input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-input);
            font-size: 1em;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .input-field input:focus {
            outline: none;
            border-color: var(--primary-accent);
            box-shadow: 0 0 0 4px rgba(0, 137, 240, 0.2);
        }

        .input-field input::placeholder {
            color: var(--text-tertiary);
            opacity: 0.8;
        }

        /* Drug Card Styling */
        .drugs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .drug-card {
            border-radius: var(--radius-card);
            padding: 20px;
            border-left: 8px solid;
            background: var(--bg-secondary);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .drug-card:hover {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-5px);
            background: var(--bg-card);
        }

        .drug-card.induction { border-left-color: var(--induction); }
        .drug-card.muscle-relaxant { border-left-color: var(--muscle-relaxant); }
        .drug-card.analgesic { border-left-color: var(--analgesic); }
        .drug-card.adjunct { border-left-color: var(--adjunct); }
        .drug-card.reversal { border-left-color: var(--reversal); }
        .drug-card.emergency { border-left-color: var(--emergency); }
        .drug-card.steroid { border-left-color: var(--steroid); }
        .drug-card.antiemetic { border-left-color: var(--antiemetic); }

        .drug-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .drug-name {
            font-weight: 700;
            font-size: 1.3em;
            color: var(--text-primary);
        }

        .drug-category {
            font-size: 0.75em;
            padding: 5px 12px;
            border-radius: 25px;
            color: var(--bg-primary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .drug-category.induction { background: var(--induction); }
        .drug-category.muscle-relaxant { background: var(--muscle-relaxant); }
        .drug-category.analgesic { background: var(--analgesic); }
        .drug-category.adjunct { background: var(--adjunct); }
        .drug-category.reversal { background: var(--reversal); }
        .drug-category.emergency { background: var(--emergency); color: var(--text-primary); }
        .drug-category.steroid { background: var(--steroid); }
        .drug-category.antiemetic { background: var(--antiemetic); }

        .dose-info {
            font-size: 0.8em;
            color: var(--text-secondary);
            font-style: italic;
            margin-top: 4px;
        }

        .calculation {
            background: var(--bg-card);
            padding: 15px;
            border-radius: var(--radius-input);
            margin-top: 15px;
            border: 1px solid var(--border-color);
        }

        .calculation-result {
            font-weight: 800; /* Increased weight for punch */
            font-size: 1.4em; /* Slightly larger for emphasis */
            color: var(--reversal); /* Vibrant Red for the final dose number */
        }

        .volume-result {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-top: 5px;
            font-weight: 500;
        }

        .edit-btn {
            background: transparent;
            border: 2px solid var(--primary-accent);
            padding: 8px 18px;
            border-radius: 50px;
            font-size: 0.85em;
            cursor: pointer;
            color: var(--primary-accent);
            margin-top: 12px;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .edit-btn:hover {
            background: var(--primary-accent);
            color: var(--bg-primary);
            box-shadow: 0 4px 10px rgba(0, 137, 240, 0.3);
        }

        .edit-inputs {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: var(--radius-input);
            border: 1px dashed var(--text-tertiary);
            animation: fadeIn 0.3s ease-in-out;
        }

        .edit-inputs.active {
            display: block;
        }

        .edit-inputs input {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.9em;
        }

        .edit-inputs input::placeholder {
            color: var(--text-tertiary);
            font-weight: 400;
        }

        /* Equipment Card Styling */
        .equipment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .equipment-card {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: var(--radius-card);
            text-align: center;
            border-top: 5px solid var(--primary-accent);
            transition: all 0.3s ease;
        }

        .equipment-card:hover {
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }

        .equipment-title {
            font-size: 0.95em;
            color: var(--text-secondary);
            margin-bottom: 10px;
            font-weight: 600;
        }

        .equipment-value {
            font-size: 1.9em;
            font-weight: 800;
            color: var(--primary-accent);
            line-height: 1.1;
        }

        .equipment-detail {
            font-size: 0.8em;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        .warning {
            background: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 15px 20px;
            margin: 25px 0;
            border-radius: 8px;
            font-size: 0.95em;
            color: #856404;
            font-weight: 500;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        body.dark-mode .warning {
            background: #4a3f00;
            color: #ffeb3b;
            border-left: 5px solid #ff9800;
        }

        /* Keyframes */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px 10px;
            }

            h1 {
                font-size: 1.8em;
            }

            .drugs-grid {
                grid-template-columns: 1fr;
            }

            .equipment-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }

            header {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Pediatric Anesthesia Calculator</h1>
            <button class="dark-mode-toggle" onclick="toggleDarkMode()">🌙 Dark Mode</button>
        </header>

        <div class="warning">
            ⚠️ This calculator is for reference only. Always verify calculations and use clinical judgment. Dosages may need adjustment based on patient condition and local protocols.
        </div>

        <section class="patient-info">
            <h2>Patient Information</h2>
            <div class="input-group">
                <div class="input-field">
                    <label for="age">Age (years)</label>
                    <input type="number" id="age" placeholder="Enter age" step="0.1" min="0" oninput="calculateAll()">
                </div>
                <div class="input-field">
                    <label for="weight">Weight (kg)</label>
                    <input type="number" id="weight" placeholder="Enter weight" step="0.1" min="0" oninput="calculateAll()">
                </div>
                <div class="input-field">
                    <label for="currentHb">Current Hb (g/dL)</label>
                    <input type="number" id="currentHb" placeholder="e.g., 12.0" step="0.1" min="0" oninput="calculateAll()">
                </div>
                <div class="input-field">
                    <label for="targetHb">Target Hb (g/dL)</label>
                    <input type="number" id="targetHb" placeholder="e.g., 8.0" step="0.1" min="0" oninput="calculateAll()">
                </div>
            </div>
        </section>

        <section class="section">
            <h2>Airway Equipment Sizing</h2>
            <div id="equipment-results" class="equipment-grid"></div>
        </section>

        <section class="section">
            <h2>Fluid & Blood Loss Requirements</h2>
            <div id="fluid-results" class="equipment-grid"></div>
        </section>

        <section class="section">
            <h2>Drug Calculations</h2>
            <div id="drug-results" class="drugs-grid"></div>
        </section>
    </div>

    <script>
        const drugs = [
            {
                name: 'Propofol',
                category: 'induction',
                categoryLabel: 'Induction Agent',
                defaultDose: 2.5,
                unit: 'mg/kg',
                concentration: 10,
                concentrationUnit: 'mg/mL',
                useParam: 'weight',
                range: '2-3 mg/kg'
            },
            {
                name: 'Thiopentone',
                category: 'induction',
                categoryLabel: 'Induction Agent',
                defaultDose: 5,
                unit: 'mg/kg',
                concentration: 25,
                concentrationUnit: 'mg/mL',
                useParam: 'weight',
                range: '4-6 mg/kg'
            },
            {
                name: 'Ketamine',
                category: 'induction',
                categoryLabel: 'Induction Agent',
                defaultDose: 2,
                unit: 'mg/kg',
                concentration: 50,
                concentrationUnit: 'mg/mL',
                useParam: 'weight',
                range: '1-2 mg/kg IV, 4-6 mg/kg IM'
            },
            {
                name: 'Vecuronium',
                category: 'muscle-relaxant',
                categoryLabel: 'Muscle Relaxant',
                defaultDose: 0.1,
                unit: 'mg/kg',
                concentration: 1,
                concentrationUnit: 'mg/mL',
                useParam: 'weight',
                range: '0.08-0.1 mg/kg'
            },
            {
                name: 'Rocuronium',
                category: 'muscle-relaxant',
                categoryLabel: 'Muscle Relaxant',
                defaultDose: 0.6,
                unit: 'mg/kg',
                concentration: 10,
                concentrationUnit: 'mg/mL',
                useParam: 'weight',
                range: '0.6-1.2 mg/kg'
            },
            {
                name: 'Atracurium',
                category: 'muscle-relaxant',
                categoryLabel: 'Muscle Relaxant',
                defaultDose: 0.5,
                unit: 'mg/kg',
                concentration: 10,
                concentrationUnit: 'mg/mL',
                useParam: 'weight',
                range: '0.4-0.5 mg/kg'
            },
            {
                name: 'Succinylcholine',
                category: 'muscle-relaxant',
                categoryLabel: 'Muscle Relaxant',
                defaultDose: 1.5,
                unit: 'mg/kg',
                concentration: 20,
                concentrationUnit: 'mg/mL',
                useParam: 'weight',
                range: '1-2 mg/kg IV, 3-4 mg/kg IM'
            },
            {
                name: 'Fentanyl',
                category: 'analgesic',
                categoryLabel: 'Opioid Analgesic',
                defaultDose: 2,
                unit: 'mcg/kg',
                concentration: 50,
                concentrationUnit: 'mcg/mL',
                useParam: 'weight',
                range: '1-3 mcg/kg'
            },
            {
                name: 'Morphine',
                category: 'analgesic',
                categoryLabel: 'Opioid Analgesic',
                defaultDose: 0.1,
                unit: 'mg/kg',
                concentration: 1,
                concentrationUnit: 'mg/mL',
                useParam: 'weight',
                range: '0.05-0.2 mg/kg'
            },
            {
                name: 'Tramadol',
                category: 'analgesic',
                categoryLabel: 'Analgesic',
                defaultDose: 1,
                unit: 'mg/kg',
                concentration: 50,
                concentrationUnit: 'mg/mL',
                useParam: 'weight',
                range: '1-2 mg/kg'
            },
            {
                name: 'Paracetamol (IV)',
                category: 'analgesic',
                categoryLabel: 'Analgesic',
                defaultDose: 15,
                unit: 'mg/kg',
                concentration: 10,
                concentrationUnit: 'mg/mL',
                useParam: 'weight',
                range: '10-15 mg/kg (max 1g)',
                maxDose: 1000
            },
            {
                name: 'Midazolam',
                category: 'adjunct',
                categoryLabel: 'Sedative',
                defaultDose: 0.1,
                unit: 'mg/kg',
                concentration: 1,
                concentrationUnit: 'mg/mL',
                useParam: 'weight',
                range: '0.05-0.2 mg/kg'
            },
            {
                name: 'Lidocaine (Xylocard)',
                category: 'adjunct',
                categoryLabel: 'Local Anesthetic',
                defaultDose: 1.5,
                unit: 'mg/kg',
                concentration: 20,
                concentrationUnit: 'mg/mL',
                useParam: 'weight',
                range: '1-1.5 mg/kg IV',

            },
            {
                name: 'Dexamethasone',
                category: 'steroid',
                categoryLabel: 'Steroid',
                defaultDose: 0.15,
                unit: 'mg/kg',
                concentration: 4,
                concentrationUnit: 'mg/mL',
                useParam: 'weight',
                range: '0.1-0.2 mg/kg (max 8mg)',
                maxDose: 8
            },
            {
                name: 'Hydrocortisone',
                category: 'steroid',
                categoryLabel: 'Steroid',
                defaultDose: 1,
                unit: 'mg/kg',
                concentration: 50,
                concentrationUnit: 'mg/mL',
                useParam: 'weight',
                range: '1-2 mg/kg'
            },
            {
                name: 'Ondansetron',
                category: 'antiemetic',
                categoryLabel: 'Antiemetic',
                defaultDose: 0.1,
                unit: 'mg/kg',
                concentration: 2,
                concentrationUnit: 'mg/mL',
                useParam: 'weight',
                range: '0.05-0.15 mg/kg (max 8mg)',
                maxDose: 8
            },
            {
                name: 'Metoclopramide',
                category: 'antiemetic',
                categoryLabel: 'Antiemetic',
                defaultDose: 0.15,
                unit: 'mg/kg',
                concentration: 5,
                concentrationUnit: 'mg/mL',
                useParam: 'weight',
                range: '0.1-0.2 mg/kg (max 10mg)',
                maxDose: 10
            },
            {
                name: 'Atropine',
                category: 'emergency',
                categoryLabel: 'Anticholinergic',
                defaultDose: 0.02,
                unit: 'mg/kg',
                concentration: 0.6,
                concentrationUnit: 'mg/mL',
                useParam: 'weight',
                range: '0.01-0.02 mg/kg (min 0.1mg)',
                minDose: 0.1
            },
            {
                name: 'Neostigmine',
                category: 'reversal',
                categoryLabel: 'Reversal Agent',
                defaultDose: 0.05,
                unit: 'mg/kg',
                concentration: 2.5,
                concentrationUnit: 'mg/mL',
                useParam: 'weight',
                range: '0.04-0.08 mg/kg (max 5mg)',
                maxDose: 5
            },
            {
                name: 'Glycopyrrolate',
                category: 'reversal',
                categoryLabel: 'Anticholinergic',
                defaultDose: 0.01,
                unit: 'mg/kg',
                concentration: 0.2,
                concentrationUnit: 'mg/mL',
                useParam: 'weight',
                range: '0.008-0.01 mg/kg'
            },
            {
                name: 'Sugammadex',
                category: 'reversal',
                categoryLabel: 'Reversal Agent',
                defaultDose: 2,
                unit: 'mg/kg',
                concentration: 20,
                concentrationUnit: 'mg/mL',
                useParam: 'weight',
                range: '2-4 mg/kg (routine reversal)'
            },
            {
                name: 'Ephedrine',
                category: 'emergency',
                categoryLabel: 'Vasopressor',
                defaultDose: 0.1,
                unit: 'mg/kg',
                concentration: 3,
                concentrationUnit: 'mg/mL',
                useParam: 'weight',
                range: '0.05-0.1 mg/kg'
            },
            {
                name: 'Adrenaline (Epinephrine)',
                category: 'emergency',
                categoryLabel: 'Emergency',
                defaultDose: 10,
                unit: 'mcg/kg',
                concentration: 10,
                concentrationUnit: 'mcg/mL',
                useParam: 'weight',
                range: '10 mcg/kg IV (1:100,000)'
            }
        ];

        function getPatientData() {
            return {
                age: parseFloat(document.getElementById('age').value) || 0,
                weight: parseFloat(document.getElementById('weight').value) || 0,
                currentHb: parseFloat(document.getElementById('currentHb').value) || 0,
                targetHb: parseFloat(document.getElementById('targetHb').value) || 0
            };
        }

        function calculateETTSize(age) {
            if (age < 1) return ((age * 12) / 4 + 3.5).toFixed(1);
            if (age < 2) return '4.0';
            return ((age / 4) + 4).toFixed(1);
        }

        function calculateETTDepth(age) {
            const size = parseFloat(calculateETTSize(age));
            return (size * 3).toFixed(1);
        }

        function calculateLMASize(weight) {
            if (weight < 5) return '1';
            if (weight < 10) return '1.5';
            if (weight < 20) return '2';
            if (weight < 30) return '2.5';
            if (weight < 50) return '3';
            return '4';
        }

        function calculateIGelSize(weight) {
            if (weight < 5) return '1';
            if (weight < 10) return '1.5';
            if (weight < 25) return '2';
            if (weight < 35) return '2.5';
            if (weight < 60) return '3';
            if (weight < 90) return '4';
            return '5';
        }

        function calculateMaintenanceFluid(weight) {
            let rate = 0;
            if (weight <= 10) {
                rate = weight * 4;
            } else if (weight <= 20) {
                rate = 40 + (weight - 10) * 2;
            } else {
                rate = 60 + (weight - 20) * 1;
            }
            return rate;
        }

        function calculateEBV(weight, age) {
            if (age < 0.1) return weight * 90; // Neonate (<1 month): 90 mL/kg
            if (age < 1) return weight * 85;    // Infant (1 month to 1 year): 85 mL/kg
            if (age < 3) return weight * 80;    // Toddler (1-3 years): 80 mL/kg
            if (age < 6) return weight * 75;    // Preschooler (3-6 years): 75 mL/kg
            if (age < 12) return weight * 70;   // School age (6-12 years): 70 mL/kg
            return weight * 65;                 // Adolescent (>12 years): 65 mL/kg (or 70 based on practice)
        }

        function calculateMABL(EBV, initialHb, targetHb) {
            if (initialHb <= targetHb || initialHb === 0) return 0;
            const MABL = EBV * (initialHb - targetHb) / initialHb;
            return Math.max(0, MABL); // Ensure MABL is not negative
        }

        function calculateEquipment() {
            const patient = getPatientData();
            const equipmentHTML = `
                <div class="equipment-card">
                    <div class="equipment-title">ETT Size (Uncuffed)</div>
                    <div class="equipment-value">${calculateETTSize(patient.age)}</div>
                    <div class="equipment-detail">Depth: ${calculateETTDepth(patient.age)} cm at lips</div>
                </div>
                <div class="equipment-card">
                    <div class="equipment-title">ETT Size (Cuffed)</div>
                    <div class="equipment-value">${(calculateETTSize(patient.age) - 0.5).toFixed(1)}</div>
                    <div class="equipment-detail">Depth: ${calculateETTDepth(patient.age)} cm at lips</div>
                </div>
                <div class="equipment-card">
                    <div class="equipment-title">LMA Size</div>
                    <div class="equipment-value">${calculateLMASize(patient.weight)}</div>
                    <div class="equipment-detail">Based on weight</div>
                </div>
                <div class="equipment-card">
                    <div class="equipment-title">i-gel Size</div>
                    <div class="equipment-value">${calculateIGelSize(patient.weight)}</div>
                    <div class="equipment-detail">Based on weight</div>
                </div>
            `;
            document.getElementById('equipment-results').innerHTML = equipmentHTML;
        }

        function calculateFluids() {
            const patient = getPatientData();
            if (!patient.weight) {
                document.getElementById('fluid-results').innerHTML = '<p style="color: var(--text-secondary); grid-column: 1/-1; text-align: center;">Enter patient weight and age to calculate fluids</p>';
                return;
            }

            const maintenance = calculateMaintenanceFluid(patient.weight);
            const bolus = patient.weight * 10;
            const EBV = calculateEBV(patient.weight, patient.age);
            let MABL_Result = "N/A";
            let MABL_Detail = "Requires Current & Target Hb";

            if (patient.currentHb > 0 && patient.targetHb > 0) {
                const calculatedMABL = calculateMABL(EBV, patient.currentHb, patient.targetHb);
                MABL_Result = `${calculatedMABL.toFixed(0)} mL`;
                MABL_Detail = `Hb Drop: ${patient.currentHb.toFixed(1)} → ${patient.targetHb.toFixed(1)} g/dL`;
            } else {
                 MABL_Result = `${(EBV * 0.15).toFixed(0)} - ${(EBV * 0.3).toFixed(0)} mL`;
                 MABL_Detail = `Estimated Max (15-30% of EBV)`;
            }


            const fluidHTML = `
                <div class="equipment-card">
                    <div class="equipment-title">Maintenance Fluid</div>
                    <div class="equipment-value">${maintenance.toFixed(0)} mL/hr</div>
                    <div class="equipment-detail">4-2-1 rule</div>
                </div>
                <div class="equipment-card">
                    <div class="equipment-title">Fluid Bolus</div>
                    <div class="equipment-value">${bolus.toFixed(0)} mL</div>
                    <div class="equipment-detail">10 mL/kg</div>
                </div>
                <div class="equipment-card">
                    <div class="equipment-title">Est. Blood Volume (EBV)</div>
                    <div class="equipment-value">${EBV.toFixed(0)} mL</div>
                    <div class="equipment-detail">Age-based mL/kg used</div>
                </div>
                <div class="equipment-card">
                    <div class="equipment-title">Max Allowable Blood Loss (MABL)</div>
                    <div class="equipment-value">${MABL_Result}</div>
                    <div class="equipment-detail">${MABL_Detail}</div>
                </div>
            `;
            document.getElementById('fluid-results').innerHTML = fluidHTML;
        }

        function calculateDrugs() {
            const patient = getPatientData();
            if (!patient.weight) {
                document.getElementById('drug-results').innerHTML = '<p style="color: var(--text-secondary); grid-column: 1/-1; text-align: center;">Enter patient weight to calculate drug doses</p>';
                return;
            }

            let drugHTML = '';
            drugs.forEach((drug, index) => {
                const paramValue = patient[drug.useParam];
                let dose = paramValue * drug.defaultDose;

                if (drug.maxDose && dose > drug.maxDose) {
                    dose = drug.maxDose;
                }
                if (drug.minDose && dose < drug.minDose) {
                    dose = drug.minDose;
                }

                const volume = dose / drug.concentration;
                const doseDisplay = drug.unit.includes('mcg') ? dose.toFixed(0) : dose.toFixed(2);
                const volumeDisplay = volume.toFixed(2);
                const totalDoseUnit = drug.unit.includes('mcg') ? 'mcg' : 'mg';

                drugHTML += `
                    <div class="drug-card ${drug.category}">
                        <div class="drug-header">
                            <div class="drug-name">${drug.name}</div>
                            <div class="drug-category ${drug.category}">${drug.categoryLabel}</div>
                        </div>
                        <div class="drug-info">
                            <div class="dose-info">Dose Range: ${drug.range}</div>
                            <div class="calculation">
                                <div class="calculation-result">${doseDisplay} ${totalDoseUnit}</div>
                                <div class="volume-result">Volume: ${volumeDisplay} mL (@ ${drug.concentration} ${drug.concentrationUnit})</div>
                                <div class="dose-info">Default: ${drug.defaultDose} ${drug.unit}</div>
                            </div>
                            <button class="edit-btn" onclick="toggleEdit(${index})">Edit Dose/Dilution</button>
                            <div class="edit-inputs" id="edit-${index}">
                                <input type="number" step="0.01" placeholder="Dose per kg (${drug.unit})" 
                                    id="dose-${index}" value="${drug.defaultDose}" 
                                    onchange="updateDrug(${index})">
                                <input type="number" step="0.1" placeholder="Concentration (${drug.concentrationUnit})" 
                                    id="conc-${index}" value="${drug.concentration}"
                                    onchange="updateDrug(${index})">
                            </div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('drug-results').innerHTML = drugHTML;
        }

        function toggleEdit(index) {
            const editDiv = document.getElementById(`edit-${index}`);
            editDiv.classList.toggle('active');
        }

        function updateDrug(index) {
            const newDose = parseFloat(document.getElementById(`dose-${index}`).value);
            const newConc = parseFloat(document.getElementById(`conc-${index}`).value);

            // Only update if a positive number is entered
            if (!isNaN(newDose) && newDose > 0) drugs[index].defaultDose = newDose;
            if (!isNaN(newConc) && newConc > 0) drugs[index].concentration = newConc;

            calculateDrugs();
        }

        function calculateAll() {
            calculateEquipment();
            calculateFluids();
            calculateDrugs();
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
            document.querySelector('.dark-mode-toggle').textContent = isDark ? '☀️ Light Mode' : '🌙 Dark Mode';
        }

        window.onload = function() {
            const savedDarkMode = localStorage.getItem('darkMode') === 'true';
            if (savedDarkMode) {
                document.body.classList.add('dark-mode');
                document.querySelector('.dark-mode-toggle').textContent = '☀️ Light Mode';
            }
            calculateAll();

            // PWA: Register the Service Worker
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/sw.js')
                        .then(reg => {
                            console.log('Service Worker registered! Scope: ', reg.scope);
                        })
                        .catch(err => {
                            console.log('Service Worker registration failed: ', err);
                        });
                });
            }
        };
    </script>
    <p style="text-align: center; margin-top: 20px;"><font color="grey" style="font-size: 0.85em;">Ⓡ︎ Dr. Kiranraj</p></font>
</body>
</html>